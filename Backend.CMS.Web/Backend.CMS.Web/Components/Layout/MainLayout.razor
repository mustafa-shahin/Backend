@using Backend.CMS.Blazor.Services
@using Backend.CMS.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthStateProvider
@inject IThemeService ThemeService
@inject NavigationManager Navigation
@inject INotificationService NotificationService
@inject IDialogService DialogService

<CascadingAuthenticationState>
    <AuthorizeView Roles="Admin,Dev">
        <Authorized>
            <div class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
                <Sidebar @bind-IsCollapsed="isSidebarCollapsed" />
                
                <div class="@GetMainContentClasses()">
                    <Header OnToggleSidebar="ToggleSidebar" 
                            OnThemeToggle="ToggleTheme"
                            IsSidebarCollapsed="isSidebarCollapsed" />
                    
                    <main class="flex-1 overflow-auto">
                        <div class="p-6">
                            @Body
                        </div>
                    </main>
                </div>
                
                <NotificationContainer />
                
                <DialogContainer />
            </div>
        </Authorized>
        <NotAuthorized>
            <LoginPage />
        </NotAuthorized>
    </AuthorizeView>
</CascadingAuthenticationState>

@code {
    private bool isSidebarCollapsed = false;

    protected override async Task OnInitializedAsync()
    {
        // Initialize theme
        await ThemeService.GetThemeAsync();
    }

    private void ToggleSidebar()
    {
        isSidebarCollapsed = !isSidebarCollapsed;
        StateHasChanged(); 
    }

    private async Task ToggleTheme()
    {
        await ThemeService.ToggleThemeAsync();
    }

    private string GetMainContentClasses()
    {
        var baseClasses = "flex-1 flex flex-col transition-all duration-300";
        var marginClass = isSidebarCollapsed ? "ml-16" : "ml-64";
        return $"{baseClasses} {marginClass}";
    }
}