@page "/products/categories"
@using Backend.CMS.Application.DTOs
@using Frontend.Components.Categories
@using Frontend.Components.Common.GenericCrudPage
@using Frontend.Interfaces
@using Frontend.Components.Common
@using Frontend.Components.Files
@inject ICategoryService CategoryService
@inject IFileService FileService
@inject INotificationService NotificationService
@inject IStyleService StyleService

<PageTitle>Categories - CMS Designer</PageTitle>

<GenericCrudPage TListItem="CategoryDto"
                 TDetailItem="CategoryDto"
                 TCreateDto="CreateCategoryDto"
                 TUpdateDto="UpdateCategoryDto"
                 PageTitle="Categories"
                 EntitySingularName="Category"
                 EntityPluralName="Categories"
                 PageDescription="Manage product categories with hierarchical organization"
                 HeaderIcon="fas fa-tags"
                 DialogSize="xlarge"
                 ShowViewModeToggle="false"
                 EmptyStateIcon="fas fa-tags"
                 EmptyStateTitle="No categories found"
                 EmptyStateMessage="Create your first product category to get started"
                 LoadDataFunc="@LoadCategoriesAsync"
                 GetByIdFunc="@GetCategoryByIdAsync"
                 CreateFunc="@CreateCategoryAsync"
                 UpdateFunc="@UpdateCategoryAsync"
                 DeleteFunc="@DeleteCategoryAsync"
                 CreateModelFactory="@CreateModelFactory"
                 EditModelFactory="@EditModelFactory"
                 CreateToUpdateMapper="@CreateToUpdateMapper"
                 ValidateFunc="@ValidateCategoryAsync"
                 OnEntityCreated="@OnCategoryCreated"
                 OnEntityUpdated="@OnCategoryUpdated"
                 OnEntityDeleted="@OnCategoryDeleted">

    <TableColumns>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-900">
            <div class="flex items-center space-x-1">
                <i class="fas fa-image text-gray-400"></i>
                <span>Image</span>
            </div>
        </th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-900">
            <div class="flex items-center space-x-1">
                <i class="fas fa-tag text-gray-400"></i>
                <span>Name</span>
            </div>
        </th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-900">
            <div class="flex items-center space-x-1">
                <i class="fas fa-link text-gray-400"></i>
                <span>Slug</span>
            </div>
        </th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-900">
            <div class="flex items-center space-x-1">
                <i class="fas fa-layer-group text-gray-400"></i>
                <span>Parent</span>
            </div>
        </th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-900">
            <div class="flex items-center space-x-1">
                <i class="fas fa-box text-gray-400"></i>
                <span>Products</span>
            </div>
        </th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-900">
            <div class="flex items-center space-x-1">
                <i class="fas fa-toggle-on text-gray-400"></i>
                <span>Status</span>
            </div>
        </th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-900">
            <div class="flex items-center space-x-1">
                <i class="fas fa-calendar text-gray-400"></i>
                <span>Created</span>
            </div>
        </th>
    </TableColumns>

    <RowTemplate Context="category">
        <!-- Image -->
        <td class="px-6 py-4 whitespace-nowrap">
            @if (!string.IsNullOrEmpty(category.FeaturedImageUrl))
            {
                <div class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600">
                    <img src="@category.FeaturedImageUrl"
                         alt="@category.Name"
                         class="w-full h-full object-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                    <div class="w-full h-full flex items-center justify-center" style="display: none;">
                        <i class="fas fa-image text-gray-400 text-xl"></i>
                    </div>
                </div>
            }
            else
            {
                <div class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center border border-gray-200 dark:border-gray-600">
                    <i class="fas fa-image text-gray-400 text-xl"></i>
                </div>
            }
        </td>

        <!-- Name -->
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
                <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-tag text-white text-sm"></i>
                </div>
                <div>
                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                        @category.Name
                    </div>
                    @if (!string.IsNullOrEmpty(category.ShortDescription))
                    {
                        <div class="text-xs text-gray-500 dark:text-gray-400 truncate max-w-xs">
                            @category.ShortDescription
                        </div>
                    }
                </div>
            </div>
        </td>

        <!-- Slug -->
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                @category.Slug
            </span>
        </td>

        <!-- Parent Category -->
        <td class="px-6 py-4 whitespace-nowrap">
            @if (!string.IsNullOrEmpty(category.ParentCategoryName))
            {
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                    <i class="fas fa-layer-group mr-1"></i>
                    @category.ParentCategoryName
                </span>
            }
            else
            {
                <span class="text-sm text-gray-500 dark:text-gray-400">Root Category</span>
            }
        </td>

        <!-- Product Count -->
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center w-fit">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                    <i class="fas fa-box mr-1"></i>
                    @category.ProductCount
                </span>
                @if (category.SubCategories.Any())
                {
                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">
                        <i class="fas fa-sitemap mr-1"></i>
                        @category.SubCategories.Count subs
                    </span>
                }
            </div>
        </td>

        <!-- Status -->
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex flex-col space-y-1 w-fit">
                @if (category.IsActive)
                {
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                        <i class="fas fa-check-circle mr-1"></i>
                        Active
                    </span>
                }
                else
                {
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">
                        <i class="fas fa-times-circle mr-1"></i>
                        Inactive
                    </span>
                }

                @if (category.IsVisible)
                {
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                        <i class="fas fa-eye mr-1"></i>
                        Visible
                    </span>
                }
                else
                {
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                        <i class="fas fa-eye-slash mr-1"></i>
                        Hidden
                    </span>
                }
            </div>
        </td>

        <!-- Created Date -->
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
            <div class="flex flex-col">
                <span>@category.CreatedAt.ToString("MMM dd, yyyy")</span>
                <span class="text-xs">@category.CreatedAt.ToString("h:mm tt")</span>
            </div>
        </td>
    </RowTemplate>

    <FilterContent>
        <div class="flex items-center space-x-3">
            <!-- Status Filter -->
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Status:</label>
                <select @bind="StatusFilter"
                        class="@StyleService.GetFormSelectClass() text-sm">
                    <option value="">All</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>

            <!-- Visibility Filter -->
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Visibility:</label>
                <select @bind="VisibilityFilter"
                        class="@StyleService.GetFormSelectClass() text-sm">
                    <option value="">All</option>
                    <option value="visible">Visible</option>
                    <option value="hidden">Hidden</option>
                </select>
            </div>

            <!-- Parent Filter -->
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Level:</label>
                <select @bind="ParentFilter"
                        class="@StyleService.GetFormSelectClass() text-sm">
                    <option value="">All</option>
                    <option value="root">Root Only</option>
                    <option value="sub">Sub-categories Only</option>
                </select>
            </div>
        </div>
    </FilterContent>


    <FormContent Context="formContext">
        <CategoryForm Model="@((CreateCategoryDto)formContext.Model)"
                      ValidationErrors="@formContext.ValidationErrors"
                      IsEditMode="@formContext.IsEditMode" />
    </FormContent>

</GenericCrudPage>

